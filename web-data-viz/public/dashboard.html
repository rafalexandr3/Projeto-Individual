<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/dash.css">
    <title>Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>

<body onload="inicializarDashboard()">

    <div class="side-bar">
        <div class="img">

            <img src="./assets/Group 3.png" alt="">
        </div>

        <div class="menu-container">
            <ul>
                <li>
                    <a href="./tela-conteudo.html"> Inicio</a>
                </li>
                <li>
                    <a href="./hiragana.html"> Hiragana </a>
                </li>

                <!-- <li><a href="./hiragana.html"></a></li> -->
                <li>
                    <a href="./QUIZZ.html"> Quiz</a>
                </li>
                <li>
                    <a href="./dashboard.html"> Dashboard</a>
                </li>
            </ul>
            <!-- <a href="#">inicio</a>
                <a href="hiragana.html">Hiragana</a>
                <a href="#">quiz</a>
                <a href="#">dash</a> -->
        </div>
    </div>

    <div class="conteudo-principal">
        <div class="titulo">
            <h1 id="titulodash"></h1>
        </div>
        <div class="kpi">
            <div class="kpi1">
                <h2> total tentativas</h2>
                <span id="tentativa" class="indicador"></span>
            </div>

            <div class="kpi4">
                <h2> Melhor nota </h2>
                <span id="melhor_nota" class="indicador"></span>
            </div>

            <div class="kpi2">
                <h2>Media notas</h2>
                <span id='media' class="indicador"></span>
            </div>
            <div class="kpi3">
                <h2> pct acertos </h2>
                <span id="acertos" class="indicador"></span>
            </div>
        </div>
        <div class="grafico">
            <canvas id="myChart"></canvas>
        </div>
    </div>


</body>

</html>

<script>
    var dados = 0;


    function buscarTentativa() {
        var idUsuario = sessionStorage.ID_USUARIO;

        fetch(`/dashboard/obterDados/${idUsuario}`)
            .then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log(resposta)
                        dados = resposta[0];
                        mostrarKpi();
                    })
                }
            })

    }

    function mostrarKpi() {
        var kpiMelhorNota = dados.melhorNota;
        var kpiTotalTentativas = dados.totalTentativas;
        var kpiMediaNotas = dados.mediaNotas;
        var kpiMediaAcertos = dados.MediaAcertos;


        tentativa.innerHTML = `${kpiTotalTentativas}`
        melhor_nota.innerHTML = `${(kpiMelhorNota).toFixed(2)}`
        media.innerHTML = `${Number(kpiMediaNotas).toFixed(2)}`
        acertos.innerHTML = `${(kpiMediaAcertos).toFixed(1)}`


    }

    function inicializarDashboard() {
        buscarTentativa();
        obterDadosGrafico();
    }

    function obterDadosGrafico() {
        var idUsuario = sessionStorage.ID_USUARIO;
        

        fetch(`/dashboard/grafico/${idUsuario}`, { cache: 'no-store' })
            .then(function (resposta) {
                if (resposta.ok) {
                    resposta.json().then(function (resposta) {
                        
                        console.log(resposta);
                        gerarGrafico(resposta)
                    });
                } else {
                    console.error('Deu xabu')
                }
            }).catch(function (error) {
                console.error('Mano deu tudo errado pra pegar esse dado')
            }

            );
    }

    function gerarGrafico(resposta) {
        var nome = sessionStorage.NOME_USUARIO;
        titulodash.innerHTML = `Acompanhe seu progresso no estudo, ${nome}!`
        var rotulo = [];    //armazena as tentativas

        var dados = {
            labels: rotulo,
            datasets: [{
                label: 'Notas',
                data: [],
                backgroundColor: 'rgba(255, 99, 132, 0.2)', // Cor de fundo das linhas
                borderColor: 'rgba(255, 99, 132, 1)', // Cor da borda das linhas
                borderWidth: 1
            }]
        };

        for (var i = 0; i < resposta.length; i++) {
            var tentativa = resposta[i];

            var numTentativa = tentativa.idTentativa;

            var nota = tentativa.notas;

            rotulo.push(`${numTentativa} tentativa`);
            dados.datasets[0].data.push(nota)
        }

        var config = {
              type: 'line',
              data: dados,
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
        }


        var myChart = new Chart(
              document.getElementById('myChart'),
              config
        );
          
        }
    
</script>